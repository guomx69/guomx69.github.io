import{J as T,aV as m,lJ as x,q as i,lK as y,lL as E,H as K,I as F,en as R,fB as D,lM as j,lN as I,kX as d,lO as q}from"./index-edf1cead.js";import{i as f}from"./originUtils-1469eeaf.js";import M from"./FeatureLayer-90942b2f.js";import{r as z}from"./fetchService-667ec519.js";import{o as w}from"./jsonContext-185d068a.js";import"./multiOriginJSONSupportUtils-c978f4c3.js";import"./FeatureLayerBase-88b29b5b.js";import"./featureLayerUtils-71d00558.js";import"./RelationshipQuery-d43a5602.js";import"./editsZScale-f46e6921.js";import"./EditBusLayer-244198d8.js";import"./FeatureEffectLayer-74d758a7.js";import"./FeatureEffect-92c7e9d5.js";import"./FeatureReductionLayer-745a30db.js";import"./clusterUtils-5ded844a.js";import"./OrderedLayer-e038abc4.js";import"./fieldProperties-1ad3ab72.js";import"./styleUtils-60111c84.js";import"./TopFeaturesQuery-d9df3d33.js";const B=T.getLogger("esri.layers.FeatureLayer"),c="Feature Service";function p(a,e){return`Layer (title: ${a.title}, id: ${a.id}) of type '${a.declaredClass}' ${e}`}function g(a,e){if(e.type!==c)throw new i("feature-layer:portal-item-wrong-type",p(a,`should have portal item of type "${c}"`))}async function J(a){if(await a.load(),x(a))throw new i("feature-layer:save",p(a,"using an in-memory source cannot be saved to a portal item"))}function U(a,e){let t=(a.messages??[]).filter(({type:r})=>r==="error").map(({name:r,message:s,details:o})=>new i(r,s,o));if(e!=null&&e.ignoreUnsupported&&(t=t.filter(({name:r})=>r!=="layer:unsupported"&&r!=="symbol:unsupported"&&r!=="symbol-layer:unsupported"&&r!=="property:unsupported"&&r!=="url:unsupported")),t.length>0)throw new i("feature-layer:save","Failed to save feature layer due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:t})}async function v(a,e,t){"beforeSave"in a&&typeof a.beforeSave=="function"&&await a.beforeSave();const r=a.write({},e);return U(e,t),r}function N(a){const{layer:e,layerJSON:t}=a;return e.isTable?{layers:[],tables:[t]}:{layers:[t],tables:[]}}function h(a){y(a,d.JSAPI),a.typeKeywords&&(a.typeKeywords=a.typeKeywords.filter((e,t,r)=>r.indexOf(e)===t))}function Y(a){const e=a.portalItem;if(!e)throw B.error("save: requires the portalItem property to be set"),new i("feature-layer:portal-item-not-set",p(a,"requires the portalItem property to be set"));if(!e.loaded)throw new i("feature-layer:portal-item-not-loaded",p(a,"cannot be saved to a portal item that does not exist or is inaccessible"));g(a,e)}async function O(a,e){return/\/\d+\/?$/.test(a.url??"")?N(e[0]):_(a,e)}async function _(a,e){const{layer:{url:t,customParameters:r,apiKey:s}}=e[0];let o=await a.fetchData("json");o&&o.layers!=null&&o.tables!=null||(o=await k(o,{url:t??"",customParameters:r,apiKey:s},e.map(l=>l.layer.layerId)));for(const l of e)A(l.layer,l.layerJSON,o);return o}async function k(a,e,t){a||(a={}),a.layers||(a.layers=[]),a.tables||(a.tables=[]);const{url:r,customParameters:s,apiKey:o}=e,{serviceJSON:l,layersJSON:n}=await z(r,{customParameters:s,apiKey:o}),u=S(a.layers,l.layers,t),b=S(a.tables,l.tables,t);a.layers=u.itemResources,a.tables=b.itemResources;const L=[...u.added,...b.added],P=n?[...n.layers,...n.tables]:[];return await C(a,L,r,P),a}function S(a,e,t){const r=E(a,e,(o,l)=>o.id===l.id);a=a.filter(o=>!r.removed.some(l=>l.id===o.id));const s=r.added.map(({id:o})=>({id:o}));return s.forEach(({id:o})=>{a.push({id:o})}),{itemResources:a,added:s.filter(({id:o})=>!t.includes(o))}}async function C(a,e,t,r){const s=e.map(({id:o})=>new M({url:t,layerId:o,sourceJSON:r.find(({id:l})=>l===o)}));await K(s.map(o=>o.load())),s.forEach(o=>{const{layerId:l,loaded:n,defaultPopupTemplate:u}=o;!n||u==null||A(o,{id:l,popupInfo:u.toJSON()},a)})}function A(a,e,t){a.isTable?$(t.tables,e):$(t.layers,e)}function $(a,e){if(!a)return;const t=a.findIndex(({id:r})=>r===e.id);t===-1?a.push(e):a[t]=e}function G(a){const{portalItem:e}=a;return q(a)&&!a.dynamicDataSource&&!!(e!=null&&e.loaded)&&e.type===c}async function H(a){if(!(a!=null&&a.length))throw new i("feature-layer-utils-saveall:missing-parameters","'layers' array should contain at least one feature layer");await Promise.all(a.map(r=>r.load()));for(const r of a)if(!G(r))throw new i("feature-layer-utils-saveall:invalid-parameters",`'layers' array should only contain layers or tables in a feature service loaded from 'Feature Service' item. ${p(r,"does not conform")}`,{layer:r});const e=a.map(r=>r.portalItem.id);if(new Set(e).size>1)throw new i("feature-layer-utils-saveall:invalid-parameters","All layers in the 'layers' array should be loaded from the same portal item");const t=a.map(r=>r.layerId);if(new Set(t).size!==t.length)throw new i("feature-layer-utils-saveall:invalid-parameters","'layers' array should contain only one instance each of layer or table in a feature service")}function V(a,e){let t=F.from(e);return t.id&&(t=t.clone(),t.id=null),t.type??(t.type=c),t.portal??(t.portal=R.getDefault()),g(a,t),t}async function X(a,e){const{url:t,layerId:r,title:s,fullExtent:o,isTable:l}=a,n=D(t),u=n!=null&&n.serverType==="FeatureServer";e.url=u?t:`${t}/${r}`,e.title||(e.title=s),e.extent=null,l||o==null||(e.extent=await j(o)),I(e,d.METADATA),I(e,d.MULTI_LAYER),y(e,d.SINGLE_LAYER),l&&y(e,d.TABLE),h(e)}async function Q(a,e,t){var s;const r=a.portal;await(r==null?void 0:r.signIn()),await((s=r==null?void 0:r.user)==null?void 0:s.addItem({item:a,data:e,folder:t==null?void 0:t.folder}))}const ba=m(W);async function W(a,e){await J(a),Y(a);const t=a.portalItem,r=w(t),s=await v(a,r,e),o=await O(t,[{layer:a,layerJSON:s}]);return h(t),await t.update({data:o}),f(r),t}const Ia=m(async(a,e)=>{await H(a);const t=a[0].portalItem,r=w(t),s=await Promise.all(a.map(l=>v(l,r,e))),o=await O(t,a.map((l,n)=>({layer:l,layerJSON:s[n]})));return h(t),await t.update({data:o}),await Promise.all(a.slice(1).map(l=>l.portalItem.reload())),f(r),t.clone()}),Sa=m(Z);async function Z(a,e,t){await J(a);const r=V(a,e),s=w(r),o=N({layer:a,layerJSON:await v(a,s,t)});return await X(a,r),await Q(r,o,t),a.portalItem=r,f(s),r}export{ba as save,Ia as saveAll,Sa as saveAs};
